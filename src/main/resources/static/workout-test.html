<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ìš´ë™ ê¸°ë¡ API í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; max-width: 1200px; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .section h3 { margin-top: 0; color: #007bff; }
        input, select, textarea, button { margin: 5px; padding: 8px; }
        button { background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .response { background: #f8f9fa; padding: 10px; border-radius: 3px; margin-top: 10px; white-space: pre-wrap; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        .api-url { font-family: monospace; background: #e9ecef; padding: 2px 5px; }
        textarea { width: 300px; height: 100px; }
        .flex { display: flex; gap: 20px; }
        .flex > div { flex: 1; }
        #logoutBtn { background: #dc3545; margin-left: 10px; }
        #loginSection { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; max-width: 400px; }
        #loginStatus { font-weight: bold; margin-left: 15px; }
        .disabled { pointer-events: none; opacity: 0.6; }
    </style>
</head>
<body>
<h1>ğŸ‹ï¸ ìš´ë™ ê¸°ë¡ API í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h1>
<p><strong>Base URL:</strong> <span class="api-url">http://localhost:8080/log</span></p>

<!-- ë¡œê·¸ì¸ ì„¹ì…˜ -->
<div id="loginSection">
    <h3>ë¡œê·¸ì¸</h3>
    <label>ì•„ì´ë””: <input type="text" id="username" placeholder="user1" /></label><br /><br />
    <label>ë¹„ë°€ë²ˆí˜¸: <input type="password" id="password" placeholder="password" /></label><br /><br />
    <button id="loginBtn">ë¡œê·¸ì¸</button>
    <button id="logoutBtn" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
    <span id="loginStatus"></span>
    <div id="loginResponse" style="margin-top:10px;"></div>
</div>

<!-- API í…ŒìŠ¤íŠ¸ ì„¹ì…˜: ë¡œê·¸ì¸ í›„ í™œì„±í™” -->
<div id="apiTests" class="disabled">
    <!-- 1. ìš´ë™ ê¸°ë¡ ìƒì„± -->
    <div class="section">
        <h3>1. ìš´ë™ ê¸°ë¡ ìƒì„±</h3>
        <p><strong>POST</strong> <span class="api-url">/log/records</span></p>

        <div class="flex">
            <div>
                <label>ë‚ ì§œ: <input type="date" id="createDate" required /></label><br />
                <label>ìš´ë™ëª…: <input type="text" id="createWorkoutName" placeholder="í‘¸ì‹œì—…" required /></label><br />
                <label>ìˆ˜í–‰ìƒíƒœ:
                    <select id="createStatus" required>
                        <option value="">ì„ íƒ</option>
                        <option value="COMPLETE">COMPLETE (ì™„ë£Œ)</option>
                        <option value="PARTIAL">PARTIAL (ë¶€ë¶„)</option>
                        <option value="INCOMPLETE">INCOMPLETE (ë¯¸ìˆ˜í–‰)</option>
                    </select>
                </label><br />
                <label>ë©”ëª¨: <textarea id="createMemo" placeholder="ìµœëŒ€ 200ì"></textarea></label><br />
                <button onclick="createRecord()">ê¸°ë¡ ìƒì„±</button>
            </div>
            <div>
                <div id="createResponse" class="response"></div>
            </div>
        </div>
    </div>

    <!-- 2. ì¼ê°„ ê¸°ë¡ ì¡°íšŒ -->
    <div class="section">
        <h3>2. ì¼ê°„ ê¸°ë¡ ì¡°íšŒ</h3>
        <p><strong>GET</strong> <span class="api-url">/log/daily?date=YYYY-MM-DD</span></p>

        <div class="flex">
            <div>
                <label>ì¡°íšŒ ë‚ ì§œ: <input type="date" id="dailyDate" required /></label><br />
                <button onclick="getDailyStats()">ì¼ê°„ ì¡°íšŒ</button>
            </div>
            <div>
                <div id="dailyResponse" class="response"></div>
            </div>
        </div>
    </div>

    <!-- 3. ì£¼ê°„ ê¸°ë¡ ì¡°íšŒ -->
    <div class="section">
        <h3>3. ì£¼ê°„ ê¸°ë¡ ì¡°íšŒ (ì°¨íŠ¸ìš©)</h3>
        <p><strong>GET</strong> <span class="api-url">/log/weekly?date=YYYY-MM-DD</span></p>

        <div class="flex">
            <div>
                <label>ê¸°ì¤€ ë‚ ì§œ: <input type="date" id="weeklyDate" required /></label><br />
                <button onclick="getWeeklyStats()">ì£¼ê°„ ì¡°íšŒ</button>
            </div>
            <div>
                <div id="weeklyResponse" class="response"></div>
            </div>
        </div>
    </div>

    <!-- 4. ì›”ê°„ ê¸°ë¡ ì¡°íšŒ -->
    <div class="section">
        <h3>4. ì›”ê°„ ê¸°ë¡ ì¡°íšŒ (íˆíŠ¸ë§µìš©)</h3>
        <p><strong>GET</strong> <span class="api-url">/log/monthly?year=YYYY&month=MM</span></p>

        <div class="flex">
            <div>
                <label>ì—°ë„: <input type="number" id="monthlyYear" value="2025" min="2020" max="2030" /></label><br />
                <label>ì›”: <input type="number" id="monthlyMonth" value="7" min="1" max="12" /></label><br />
                <button onclick="getMonthlyStats()">ì›”ê°„ ì¡°íšŒ</button>
            </div>
            <div>
                <div id="monthlyResponse" class="response"></div>
            </div>
        </div>
    </div>

    <!-- 5. AI í”¼ë“œë°± ìƒì„± -->
    <div class="section">
        <h3>5. AI í”¼ë“œë°± ìƒì„±</h3>
        <p><strong>POST</strong> <span class="api-url">/log/feedback?date=YYYY-MM-DD</span></p>

        <div class="flex">
            <div>
                <label>í”¼ë“œë°± ë‚ ì§œ: <input type="date" id="feedbackDate" required /></label><br />
                <button onclick="generateFeedback()">AI í”¼ë“œë°± ìƒì„±</button>
            </div>
            <div>
                <div id="feedbackResponse" class="response"></div>
            </div>
        </div>
    </div>

    <!-- 6. ì‚¬ì§„ ì—…ë¡œë“œ -->
    <div class="section">
        <h3>6. ì‚¬ì§„ ì—…ë¡œë“œ (ìµœëŒ€ 5ì¥)</h3>
        <p><strong>POST</strong> <span class="api-url">/log/records/{recordId}/photos</span></p>

        <div class="flex">
            <div>
                <label>ê¸°ë¡ ID: <input type="number" id="photoRecordId" placeholder="1" required /></label><br />
                <label>ì‚¬ì§„ ì„ íƒ: <input type="file" id="photoFiles" multiple accept="image/*" /></label><br />
                <button onclick="uploadPhotos()">ì‚¬ì§„ ì—…ë¡œë“œ</button>
            </div>
            <div>
                <div id="photoResponse" class="response"></div>
            </div>
        </div>
    </div>

    <!-- 7. ì „ì²´ ê¸°ë¡ ì‚­ì œ -->
    <div class="section">
        <h3>7. ì „ì²´ ê¸°ë¡ ì‚­ì œ</h3>
        <p><strong>DELETE</strong> <span class="api-url">/log/records/all</span></p>

        <button onclick="clearAllRecords()" style="background: #dc3545;">âš ï¸ ì „ì²´ ê¸°ë¡ ì‚­ì œ</button>
        <div id="clearResponse" class="response"></div>
    </div>
</div>

<script>
    const BASE_URL_AUTH = 'http://localhost:8080'; // ë¡œê·¸ì¸, ë¡œê·¸ì•„ì›ƒ API ê¸°ë³¸ URL
    const BASE_URL_API = 'http://localhost:8080/log'; // ìš´ë™ ê¸°ë¡ API ê¸°ë³¸ URL

    const loginSection = document.getElementById('loginSection');
    const apiTests = document.getElementById('apiTests');

    let authToken = null; // JWT ë˜ëŠ” ì„¸ì…˜ í† í° (í•„ìš”ì‹œ ì‚¬ìš©)

    // DOMContentLoaded ì•ˆì—ì„œ ì´ë²¤íŠ¸ ë“±ë¡ê³¼ ì´ˆê¸° UI ì„¤ì •
    document.addEventListener('DOMContentLoaded', function () {
        // ë¡œê·¸ì¸ ê´€ë ¨ ìš”ì†Œ
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginResponse = document.getElementById('loginResponse');
        const loginStatus = document.getElementById('loginStatus');

        // ê¸°ë³¸ ë‚ ì§œ ì„¸íŒ…
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('createDate').value = today;
        document.getElementById('dailyDate').value = today;
        document.getElementById('weeklyDate').value = today;
        document.getElementById('feedbackDate').value = today;

        // ë¡œê·¸ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸
        loginBtn.addEventListener('click', async () => {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!username || !password) {
                alert('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            loginResponse.textContent = 'ë¡œê·¸ì¸ ì‹œë„ ì¤‘...';
            loginResponse.style.color = '';

            try {
                const res = await fetch(`${BASE_URL_AUTH}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include', // ì„¸ì…˜ ì¿ í‚¤ ì¸ì¦ìš©
                    body: JSON.stringify({ username, password })
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    loginResponse.textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + (err.message || res.statusText);
                    loginResponse.style.color = 'red';
                    return;
                }

                // JWT í† í° ë°©ì‹ì¸ ê²½ìš° ì•„ë˜ ì½”ë“œ ì‚¬ìš©
                // const data = await res.json();
                // authToken = data.token;

                authToken = 'SESSION'; // ì„¸ì…˜ ì¸ì¦ìš© ì„ì‹œê°’

                loginResponse.textContent = 'ë¡œê·¸ì¸ ì„±ê³µ!';
                loginResponse.style.color = 'green';

                loginStatus.textContent = `ì‚¬ìš©ì: ${username}`;
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';

                apiTests.classList.remove('disabled');
            } catch (e) {
                loginResponse.textContent = 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜: ' + e.message;
                loginResponse.style.color = 'red';
            }
        });

        // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸
        logoutBtn.addEventListener('click', async () => {
            try {
                const res = await fetch(`${BASE_URL_AUTH}/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (res.ok) {
                    loginResponse.textContent = 'ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    loginResponse.style.color = 'green';

                    authToken = null;
                    loginStatus.textContent = '';
                    loginBtn.style.display = 'inline-block';
                    logoutBtn.style.display = 'none';

                    apiTests.classList.add('disabled');
                } else {
                    loginResponse.textContent = 'ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨';
                    loginResponse.style.color = 'red';
                }
            } catch (e) {
                loginResponse.textContent = 'ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜: ' + e.message;
                loginResponse.style.color = 'red';
            }
        });
    });

    // API í˜¸ì¶œ ì‹œ ì˜µì…˜ì— credentials: 'include' ì¶”ê°€ (ì„¸ì…˜ ì¸ì¦ ì‹œ)
    // JWT í† í° ì¸ì¦ì¼ ê²½ìš° headersì— Authorization: 'Bearer ' + authToken ì¶”ê°€ í•„ìš”

    // 1. ìš´ë™ ê¸°ë¡ ìƒì„±
    async function createRecord() {
        if (!checkLogin()) return;

        const data = {
            date: document.getElementById('createDate').value,
            workoutName: document.getElementById('createWorkoutName').value,
            status: document.getElementById('createStatus').value,
            memo: document.getElementById('createMemo').value
        };

        try {
            const response = await fetch(`${BASE_URL_API}/records`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // 'Authorization': 'Bearer ' + authToken // JWT ì¸ì¦ì¼ ë•Œ ì ìš©
                },
                credentials: 'include',
                body: JSON.stringify(data)
            });

            const result = await response.json();
            displayResponse('createResponse', result, response.ok);
        } catch (error) {
            displayResponse('createResponse', { error: error.message }, false);
        }
    }

    // 2. ì¼ê°„ ì¡°íšŒ
    async function getDailyStats() {
        if (!checkLogin()) return;

        const date = document.getElementById('dailyDate').value;
        try {
            const response = await fetch(`${BASE_URL_API}/daily?date=${date}`, {
                credentials: 'include'
            });
            const result = await response.json();
            displayResponse('dailyResponse', result, response.ok);
        } catch (error) {
            displayResponse('dailyResponse', { error: error.message }, false);
        }
    }

    // 3. ì£¼ê°„ ì¡°íšŒ
    async function getWeeklyStats() {
        if (!checkLogin()) return;

        const date = document.getElementById('weeklyDate').value;
        try {
            const response = await fetch(`${BASE_URL_API}/weekly?date=${date}`, {
                credentials: 'include'
            });
            const result = await response.json();
            displayResponse('weeklyResponse', result, response.ok);
        } catch (error) {
            displayResponse('weeklyResponse', { error: error.message }, false);
        }
    }

    // 4. ì›”ê°„ ì¡°íšŒ
    async function getMonthlyStats() {
        if (!checkLogin()) return;

        const year = document.getElementById('monthlyYear').value;
        const month = document.getElementById('monthlyMonth').value;
        try {
            const response = await fetch(`${BASE_URL_API}/monthly?year=${year}&month=${month}`, {
                credentials: 'include'
            });
            const result = await response.json();
            displayResponse('monthlyResponse', result, response.ok);
        } catch (error) {
            displayResponse('monthlyResponse', { error: error.message }, false);
        }
    }

    // 5. AI í”¼ë“œë°± ìƒì„±
    async function generateFeedback() {
        if (!checkLogin()) return;

        const date = document.getElementById('feedbackDate').value;
        try {
            const response = await fetch(`${BASE_URL_API}/feedback?date=${date}`, {
                method: 'POST',
                credentials: 'include'
            });
            const result = await response.json();
            displayResponse('feedbackResponse', result, response.ok);
        } catch (error) {
            displayResponse('feedbackResponse', { error: error.message }, false);
        }
    }

    // 6. ì‚¬ì§„ ì—…ë¡œë“œ
    async function uploadPhotos() {
        if (!checkLogin()) return;

        const recordId = document.getElementById('photoRecordId').value;
        const files = document.getElementById('photoFiles').files;

        if (!recordId || files.length === 0) {
            displayResponse('photoResponse', { error: 'ê¸°ë¡ IDì™€ ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.' }, false);
            return;
        }

        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]);
        }

        try {
            const response = await fetch(`${BASE_URL_API}/records/${recordId}/photos`, {
                method: 'POST',
                credentials: 'include',
                body: formData
            });
            const result = await response.json();
            displayResponse('photoResponse', result, response.ok);
        } catch (error) {
            displayResponse('photoResponse', { error: error.message }, false);
        }
    }

    // 7. ì „ì²´ ê¸°ë¡ ì‚­ì œ
    async function clearAllRecords() {
        if (!checkLogin()) return;

        if (!confirm('ì •ë§ë¡œ ëª¨ë“  ìš´ë™ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const response = await fetch(`${BASE_URL_API}/records/all`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (response.ok) {
                displayResponse('clearResponse', { message: 'ëª¨ë“  ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' }, true);
            } else {
                displayResponse('clearResponse', { error: 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, false);
            }
        } catch (error) {
            displayResponse('clearResponse', { error: error.message }, false);
        }
    }

    // ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬ & ì•Œë¦¼ í‘œì‹œ ê¸°ëŠ¥ ì¶”ê°€
    function checkLogin() {
        if (!authToken) {
            alert('API í…ŒìŠ¤íŠ¸ ì „ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return false;
        }
        return true;
    }

    // ì‘ë‹µ í‘œì‹œ í•¨ìˆ˜
    function displayResponse(elementId, data, success) {
        const element = document.getElementById(elementId);
        element.className = `response ${success ? 'success' : 'error'}`;
        element.textContent = JSON.stringify(data, null, 2);
    }
</script>
</body>
</html>
